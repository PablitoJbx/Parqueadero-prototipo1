<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Parqueadero Prototipo</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@700;400&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Montserrat', Arial, sans-serif; margin: 0; background: #eaf0f6; }
    .container { max-width: 600px; margin: 2rem auto; padding: 2rem; background: #fff; border-radius: 16px; box-shadow: 0 4px 24px #0002; }
    .logo {
      display: flex; align-items: center; gap: 1rem; margin-bottom: 2rem;
    }
    .logo-icon {
      width: 56px; height: 56px; background: #2980b9; border-radius: 50%; display: flex; align-items: center; justify-content: center;
    }
    .logo-icon svg { width: 36px; height: 36px; fill: #fff; }
    .logo-title { font-size: 2rem; font-weight: 700; color: #2980b9; letter-spacing: 1px; }
    h2 { color: #2c3e50; margin-top: 2rem; }
    form, .vehiculos { background: #f8fafc; padding: 1.5rem; margin-bottom: 2rem; border-radius: 12px; box-shadow: 0 2px 8px #0001; }
    label { display: block; margin-top: 1rem; font-weight: 500; }
    input, select { padding: 0.5rem; margin-top: 0.5rem; width: 100%; border-radius: 6px; border: 1px solid #b0c4d6; font-size: 1rem; }
    button { margin-top: 1rem; padding: 0.7rem 1.5rem; background: #2980b9; color: #fff; border: none; border-radius: 6px; cursor: pointer; font-size: 1rem; font-weight: 600; transition: background 0.2s; }
    button:hover { background: #3498db; }
    .error, .success { margin-top: 1rem; font-size: 1rem; font-weight: 600; }
    .error { color: #e74c3c; }
    .success { color: #27ae60; }
    table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
    th, td { padding: 0.7rem; border-bottom: 1px solid #dbe6f3; text-align: center; }
    th { background: #2980b9; color: #fff; font-weight: 700; }
    tr:last-child td { border-bottom: none; }
    .spinner {
      display: inline-block;
      width: 24px;
      height: 24px;
      border: 3px solid #2980b9;
      border-top: 3px solid #fff;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      vertical-align: middle;
      margin-right: 8px;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    @media (max-width: 700px) {
      .container { padding: 1rem; }
      .logo-title { font-size: 1.3rem; }
    }
    .login-register {
      background: #f8fafc;
      padding: 1.5rem;
      border-radius: 12px;
      box-shadow: 0 2px 8px #0001;
      margin-bottom: 2rem;
      max-width: 400px;
      margin-left: auto;
      margin-right: auto;
    }
    .login-register h2 { margin-top: 0; }
    .parking-map {
      display: grid;
      grid-template-columns: repeat(5, 60px);
      gap: 16px;
      justify-content: center;
      margin: 2rem 0;
    }
    .space {
      width: 60px; height: 80px;
      background: #dbe6f3;
      border-radius: 8px;
      display: flex; flex-direction: column; align-items: center; justify-content: center;
      box-shadow: 0 2px 6px #0001;
      cursor: pointer;
      position: relative;
      transition: background 0.2s;
    }
    .space.occupied { background: #e74c3c; color: #fff; }
    .space.selected { background: #2980b9; color: #fff; }
    .space .placa { font-size: 0.9rem; font-weight: bold; margin-top: 0.3rem; }
    .space .tipo { font-size: 0.8rem; }
    .space .actions { margin-top: 0.5rem; display: flex; gap: 4px; }
    .space button { padding: 0.2rem 0.5rem; font-size: 0.8rem; border-radius: 4px; border: none; cursor: pointer; }
    .space button.add { background: #27ae60; color: #fff; }
    .space button.remove { background: #e67e22; color: #fff; }
    .space button:disabled { background: #ccc; color: #fff; cursor: not-allowed; }
    /* Estilos para el men√∫ superior */
    .menu-superior {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
    }
    .menu-superior button {
      background: #2980b9;
      color: #fff;
      border: none;
      border-radius: 6px;
      padding: 0.5rem 1rem;
      cursor: pointer;
      font-size: 0.9rem;
      font-weight: 600;
      transition: background 0.2s;
      margin-left: 0.5rem;
    }
    .menu-superior button:hover {
      background: #3498db;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="logo">
      <div class="logo-icon">
        <!-- Simple parking logo SVG -->
        <svg viewBox="0 0 48 48"><circle cx="24" cy="24" r="22" fill="#fff"/><rect x="14" y="14" width="20" height="20" rx="6" fill="#2980b9"/><text x="24" y="32" text-anchor="middle" font-size="18" fill="#fff" font-family="Arial" font-weight="bold">P</text></svg>
      </div>
      <span class="logo-title">Parqueadero Prototipo</span>
    </div>
    <!-- Men√∫ superior para login, registro, historial y configuraci√≥n -->
    <div class="menu-superior">
      <div>
        <button id='btnLogin'>Iniciar sesi√≥n</button>
        <button id='btnRegister'>Registrarse</button>
        <button id='btnLogout' style='display:none;'>Cerrar sesi√≥n</button>
      </div>
      <div>
        <button id='btnHistorial'>Historial</button>
        <button id='btnTarifas'>Configurar Tarifas</button>
      </div>
    </div>
    <!-- Formularios y tabla funcionales -->
    <div id="mainApp">
      <h2 style="text-align:center;">Mapa del Parqueadero</h2>
      <div class="parking-map" id="parkingMap"></div>
      <div id="parkingMsg" style="text-align:center;"></div>
      <form id="entradaForm">
        <h3>Registrar Entrada</h3>
        <label for="placaEntrada">Placa:</label>
        <input id="placaEntrada" maxlength="10" required pattern="[A-Z0-9]{5,10}" placeholder="Ej: ABC123" />
        <label for="tipoEntrada">Tipo:</label>
        <select id="tipoEntrada">
          <option value="carro">Carro</option>
          <option value="moto">Moto</option>
        </select>
        <button type="submit">Registrar Entrada</button>
        <div id="entradaMsg"></div>
      </form>
      <form id="salidaForm">
        <h3>Registrar Salida</h3>
        <label for="placaSalida">Placa:</label>
        <input id="placaSalida" maxlength="10" required pattern="[A-Z0-9]{5,10}" placeholder="Ej: ABC123" />
        <button type="submit">Registrar Salida</button>
        <div id="salidaMsg"></div>
      </form>
      <div class="vehiculos">
        <h3>Veh√≠culos en el Parqueadero</h3>
        <table id="tablaVehiculos">
          <thead><tr><th>Placa</th><th>Tipo</th><th>Hora de Entrada</th></tr></thead>
          <tbody></tbody>
        </table>
        <div id="tablaMsg"></div>
      </div>
    </div>
  </div>
  <script>
    const api = ''; // Si frontend y backend est√°n juntos, dejar vac√≠o. Si est√°n separados, poner la URL del backend.
    function mostrarCargando(msg) {
      document.getElementById('tablaMsg').innerHTML = `<span class="spinner"></span>${msg}`;
      document.getElementById('tablaMsg').className = 'success';
    }
    async function cargarVehiculos() {
      mostrarCargando('Cargando veh√≠culos...');
      try {
        const res = await fetch(api + '/parqueadero');
        if (!res.ok) throw new Error('No se pudo cargar');
        const vehiculos = await res.json();
        const tbody = document.querySelector('#tablaVehiculos tbody');
        tbody.innerHTML = '';
        if (vehiculos.length === 0) {
          document.getElementById('tablaMsg').textContent = 'No hay veh√≠culos en el parqueadero.';
          document.getElementById('tablaMsg').className = '';
        } else {
          document.getElementById('tablaMsg').textContent = '';
          vehiculos.forEach((v, i) => {
            const tr = document.createElement('tr');
            tr.innerHTML = `<td>${v.placa}</td><td>${v.tipo}</td><td>${new Date(v.horaEntrada).toLocaleString()}</td>`;
            tr.style.opacity = 0;
            setTimeout(() => { tr.style.transition = 'opacity 0.5s'; tr.style.opacity = 1; }, 100 * i);
            tbody.appendChild(tr);
          });
        }
      } catch (err) {
        document.getElementById('tablaMsg').textContent = 'Error al cargar veh√≠culos.';
        document.getElementById('tablaMsg').className = 'error';
      }
    }
    document.getElementById('entradaForm').onsubmit = async e => {
      e.preventDefault();
      const placa = document.getElementById('placaEntrada').value.trim().toUpperCase();
      const tipo = document.getElementById('tipoEntrada').value;
      const msg = document.getElementById('entradaMsg');
      msg.textContent = '';
      msg.className = '';
      if (!placa.match(/^[A-Z0-9]{5,10}$/)) {
        msg.textContent = 'Placa inv√°lida. Debe tener entre 5 y 10 caracteres alfanum√©ricos.';
        msg.className = 'error';
        return;
      }
      try {
        msg.textContent = 'Registrando...';
        msg.className = 'success';
        const res = await fetch(api + '/entrada', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ placa, tipo })
        });
        if (res.ok) {
          msg.textContent = 'Veh√≠culo registrado correctamente.';
          msg.className = 'success';
          cargarVehiculos();
          e.target.reset();
        } else {
          const data = await res.json();
          msg.textContent = data.error || 'Error al registrar entrada.';
          msg.className = 'error';
        }
      } catch {
        msg.textContent = 'Error de red al registrar entrada.';
        msg.className = 'error';
      }
    };
    document.getElementById('salidaForm').onsubmit = async e => {
      e.preventDefault();
      const placa = document.getElementById('placaSalida').value.trim().toUpperCase();
      const msg = document.getElementById('salidaMsg');
      msg.textContent = '';
      msg.className = '';
      if (!placa.match(/^[A-Z0-9]{5,10}$/)) {
        msg.textContent = 'Placa inv√°lida. Debe tener entre 5 y 10 caracteres alfanum√©ricos.';
        msg.className = 'error';
        return;
      }
      try {
        msg.textContent = 'Procesando salida...';
        msg.className = 'success';
        const res = await fetch(api + '/salida', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ placa })
        });
        if (res.ok) {
          msg.textContent = 'Salida registrada correctamente.';
          msg.className = 'success';
          cargarVehiculos();
          e.target.reset();
        } else {
          const data = await res.json();
          msg.textContent = data.error || 'Error al registrar salida.';
          msg.className = 'error';
        }
      } catch {
        msg.textContent = 'Error de red al registrar salida.';
        msg.className = 'error';
      }
    };
    // --- Parking map logic ---
    const NUM_SPACES = 15;
    let parkingSpaces = Array(NUM_SPACES).fill(null);
    const spaceLabels = [
      'A1','A2','A3','A4','A5',
      'B1','B2','B3','B4','B5',
      'C1','C2','C3','C4','C5'
    ];
    // Guardar y cargar estado en localStorage para persistencia b√°sica
    function saveParkingState() {
      localStorage.setItem('parkingSpaces', JSON.stringify(parkingSpaces));
    }
    function loadParkingState() {
      const data = localStorage.getItem('parkingSpaces');
      if (data) {
        try {
          const arr = JSON.parse(data);
          if (Array.isArray(arr) && arr.length === NUM_SPACES) {
            parkingSpaces = arr;
          }
        } catch {}
      }
    }

    // Cambia la extensi√≥n de la imagen a la correcta
    const CAR_IMAGE = 'car-sprite.png.jpg'; // Usa la imagen real en public
    const MOTO_EMOJI = 'üèçÔ∏è';

    function getCarImageHTML(idx) {
      // Sprite: 5 autos por fila, 2 filas (ajustar si usas otra imagen)
      const col = idx % 5;
      const row = Math.floor(idx / 5);
      const x = -col * 92; // 920px/10 autos = 92px por auto
      const y = -row * 225; // 450px/2 filas = 225px por fila
      return `<div style="width:60px;height:80px;display:flex;align-items:center;justify-content:center;overflow:hidden;">
        <img src='${CAR_IMAGE}' style='width:460px;height:225px;object-fit:none;object-position:${x}px ${y}px;' alt='Carro'/>
      </div>`;
    }

    // Obtener tarifas del backend (si hay token)
    let tarifas = { carro: 2000, moto: 1000 };
    async function fetchTarifas() {
      const token = localStorage.getItem('token');
      if (!token) return;
      try {
        const res = await fetch('/tarifas', { headers: { Authorization: 'Bearer ' + token } });
        if (res.ok) tarifas = await res.json();
      } catch {}
    }
    // Llamar al cargar
    fetchTarifas();

    function renderParkingMap() {
      const map = document.getElementById('parkingMap');
      map.innerHTML = '';
      parkingSpaces.forEach((car, idx) => {
        const div = document.createElement('div');
        div.className = 'space' + (car ? ' occupied' : '');
        div.title = `Espacio ${spaceLabels[idx]}`;
        div.innerHTML = `<div style='font-weight:bold;font-size:1.1em;'>${spaceLabels[idx]}</div>`;
        if (car) {
          if (car.tipo === 'carro') {
            div.innerHTML += getCarImageHTML(idx);
          } else {
            div.innerHTML += `<div style='font-size:2em;margin:8px 0;'>${MOTO_EMOJI}</div>`;
          }
          div.innerHTML += `<span class='placa'>${car.placa}</span><span class='tipo'>${car.tipo}</span>`;
          // Mostrar tiempo de parqueo
          if (car.entrada) {
            const minutos = Math.floor((Date.now() - car.entrada) / 60000);
            div.innerHTML += `<div style='font-size:0.8em;color:#333;'>${minutos} min</div>`;
          }
          div.onclick = () => {
            if (confirm(`¬øSacar veh√≠culo ${car.placa} (${car.tipo}) del espacio ${spaceLabels[idx]}?`)) {
              // Calcular tarifa usando tarifas configurables
              const entrada = car.entrada || Date.now();
              const minutos = Math.max(1, Math.ceil((Date.now() - entrada) / 60000));
              let tarifa = 0;
              if (car.tipo === 'carro') {
                tarifa = Math.ceil(minutos / 60) * tarifas.carro;
              } else {
                tarifa = Math.ceil(minutos / 60) * tarifas.moto;
              }
              let metodo = prompt(`Tiempo: ${minutos} min\nTarifa: $${tarifa}\nSeleccione m√©todo de pago: efectivo, tarjeta, nequi, daviplata`).toLowerCase();
              if (!['efectivo','tarjeta','nequi','daviplata'].includes(metodo)) {
                alert('M√©todo de pago no v√°lido.');
                return;
              }
              alert(`Pago de $${tarifa} realizado con ${metodo}. ¬°Gracias!`);
              parkingSpaces[idx] = null;
              saveParkingState();
              renderParkingMap();
              document.getElementById('parkingMsg').textContent = `Veh√≠culo retirado del espacio ${spaceLabels[idx]}`;
            }
          };
        } else {
          div.onclick = () => {
            const placa = prompt(`Placa del veh√≠culo para ${spaceLabels[idx]}:`);
            if (!placa) return;
            const placaVal = placa.trim().toUpperCase();
            const tipo = prompt('Tipo (carro/moto):');
            if (!tipo) return;
            const tipoVal = tipo.trim().toLowerCase();
            if (!placaVal.match(/^[A-Z0-9]{5,10}$/) || (tipoVal !== 'carro' && tipoVal !== 'moto')) {
              alert('Datos inv√°lidos. Placa: 5-10 caracteres alfanum√©ricos. Tipo: carro o moto.');
              return;
            }
            // Validar que la placa no est√© en otro espacio
            if (parkingSpaces.some(s => s && s.placa === placaVal)) {
              alert('Esa placa ya est√° registrada en otro espacio.');
              return;
            }
            parkingSpaces[idx] = { placa: placaVal, tipo: tipoVal, entrada: Date.now() };
            saveParkingState();
            renderParkingMap();
            document.getElementById('parkingMsg').textContent = `Veh√≠culo agregado al espacio ${spaceLabels[idx]}`;
          };
        }
        map.appendChild(div);
      });
    }

    // Inicializar estado y renderizar
    loadParkingState();
    renderParkingMap();
    setInterval(cargarVehiculos, 10000);
    // Mostrar/ocultar botones seg√∫n sesi√≥n
    function updateMenuSession() {
      const token = localStorage.getItem('token');
      const rol = localStorage.getItem('rol');
      document.getElementById('btnLogin').style.display = token ? 'none' : '';
      document.getElementById('btnRegister').style.display = token ? 'none' : '';
      document.getElementById('btnLogout').style.display = token ? '' : 'none';
      document.getElementById('btnHistorial').style.display = rol === 'admin' ? '' : 'none';
      document.getElementById('btnTarifas').style.display = rol === 'admin' ? '' : 'none';
    }

    // Llamar al cargar y tras login/logout
    updateMenuSession();

    // Asignar eventos a los botones del men√∫ superior
    function assignMenuEvents() {
      document.getElementById('btnLogin').onclick = showLogin;
      document.getElementById('btnRegister').onclick = showRegister;
      document.getElementById('btnLogout').onclick = logout;
      document.getElementById('btnHistorial').onclick = showHistorial;
      document.getElementById('btnTarifas').onclick = showTarifasConfig;
    }
    assignMenuEvents();

    // L√≥gica de login, registro y logout
    function showLogin() {
      const username = prompt('Usuario:');
      const password = prompt('Contrase√±a:');
      if (!username || !password) return;
      fetch('/login', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ username, password })
      })
        .then(res => res.json())
        .then(data => {
          if (data.token) {
            localStorage.setItem('token', data.token);
            localStorage.setItem('rol', data.rol);
            alert('Bienvenido ' + username);
            updateMenuSession();
          } else {
            alert(data.error || 'Error de autenticaci√≥n');
          }
        });
    }
    function showRegister() {
      const username = prompt('Nuevo usuario:');
      const password = prompt('Contrase√±a:');
      if (!username || !password) return;
      fetch('/register', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ username, password })
      })
        .then(res => res.json())
        .then(data => {
          if (data.message) {
            alert('Usuario registrado. Ahora puedes iniciar sesi√≥n.');
            updateMenuSession();
          } else {
            alert(data.error || 'Error al registrar');
          }
        });
    }
    function logout() {
      localStorage.removeItem('token');
      localStorage.removeItem('rol');
      alert('Sesi√≥n cerrada');
      updateMenuSession();
    }

    // Men√∫ de configuraci√≥n de tarifas (solo admin)
    function showTarifasConfig() {
      const token = localStorage.getItem('token');
      if (!token) return alert('Debes iniciar sesi√≥n como admin');
      fetch('/tarifas', { headers: { Authorization: 'Bearer ' + token } })
        .then(res => res.json())
        .then(tarifas => {
          const carro = prompt('Tarifa por hora para carro:', tarifas.carro);
          const moto = prompt('Tarifa por hora para moto:', tarifas.moto);
          if (!carro || !moto) return;
          fetch('/tarifas', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              Authorization: 'Bearer ' + token
            },
            body: JSON.stringify({ carro: Number(carro), moto: Number(moto) })
          })
          .then(res => res.json())
          .then(nuevas => {
            alert('Tarifas actualizadas');
            window.location.reload();
          });
        });
    }

    // Mostrar historial de movimientos (solo admin)
    function showHistorial() {
      const token = localStorage.getItem('token');
      if (!token) return alert('Debes iniciar sesi√≥n como admin');
      fetch('/historial', { headers: { Authorization: 'Bearer ' + token } })
        .then(res => res.json())
        .then(historial => {
          if (!Array.isArray(historial)) return alert('No autorizado o error');
          let html = '<h3>Historial de Movimientos</h3>';
          html += '<table style="width:100%;font-size:0.95em;"><tr><th>Placa</th><th>Tipo</th><th>Entrada</th><th>Salida</th></tr>';
          historial.forEach(v => {
            html += `<tr><td>${v.placa}</td><td>${v.tipo}</td><td>${v.horaEntrada ? new Date(v.horaEntrada).toLocaleString() : ''}</td><td>${v.horaSalida ? new Date(v.horaSalida).toLocaleString() : ''}</td></tr>`;
          });
          html += '</table>';
          const div = document.createElement('div');
          div.innerHTML = html;
          div.style.background = '#fff';
          div.style.padding = '1rem';
          div.style.borderRadius = '12px';
          div.style.boxShadow = '0 2px 8px #0001';
          div.style.margin = '2rem auto';
          div.style.maxWidth = '600px';
          div.style.position = 'fixed';
          div.style.top = '10%';
          div.style.left = '0';
          div.style.right = '0';
          div.style.zIndex = '1000';
          div.onclick = () => div.remove();
          document.body.appendChild(div);
        });
    }

    // Men√∫ superior para login, registro, historial y configuraci√≥n
    function renderMenu() {
      const menu = document.createElement('div');
      menu.style.display = 'flex';
      menu.style.justifyContent = 'space-between';
      menu.style.alignItems = 'center';
      menu.style.marginBottom = '1rem';
      menu.innerHTML = `
        <div>
          <button id='btnLogin'>Iniciar sesi√≥n</button>
          <button id='btnRegister'>Registrarse</button>
          <button id='btnLogout' style='display:none;'>Cerrar sesi√≥n</button>
        </div>
        <div>
          <button id='btnHistorial'>Historial</button>
          <button id='btnTarifas'>Configurar Tarifas</button>
        </div>
      `;
      document.querySelector('.container').insertBefore(menu, document.querySelector('.logo').nextSibling);
      // Eventos
      document.getElementById('btnLogin').onclick = showLogin;
      document.getElementById('btnRegister').onclick = showRegister;
      document.getElementById('btnLogout').onclick = logout;
      document.getElementById('btnHistorial').onclick = showHistorial;
      document.getElementById('btnTarifas').onclick = showTarifasConfig;
    }

    renderMenu();
  </script>
</body>
</html>
