<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Parqueadero Prototipo</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@700;400&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Montserrat', Arial, sans-serif; margin: 0; background: #eaf0f6; }
    .container { max-width: 600px; margin: 2rem auto; padding: 2rem; background: #fff; border-radius: 16px; box-shadow: 0 4px 24px #0002; }
    .logo {
      display: flex; align-items: center; gap: 1rem; margin-bottom: 2rem;
    }
    .logo-icon {
      width: 56px; height: 56px; background: #2980b9; border-radius: 50%; display: flex; align-items: center; justify-content: center;
    }
    .logo-icon svg { width: 36px; height: 36px; fill: #fff; }
    .logo-title { font-size: 2rem; font-weight: 700; color: #2980b9; letter-spacing: 1px; }
    h2 { color: #2c3e50; margin-top: 2rem; }
    form, .vehiculos { background: #f8fafc; padding: 1.5rem; margin-bottom: 2rem; border-radius: 12px; box-shadow: 0 2px 8px #0001; }
    label { display: block; margin-top: 1rem; font-weight: 500; }
    input, select { padding: 0.5rem; margin-top: 0.5rem; width: 100%; border-radius: 6px; border: 1px solid #b0c4d6; font-size: 1rem; }
    button { margin-top: 1rem; padding: 0.7rem 1.5rem; background: #2980b9; color: #fff; border: none; border-radius: 6px; cursor: pointer; font-size: 1rem; font-weight: 600; transition: background 0.2s; }
    button:hover { background: #3498db; }
    .error, .success { margin-top: 1rem; font-size: 1rem; font-weight: 600; }
    .error { color: #e74c3c; }
    .success { color: #27ae60; }
    table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
    th, td { padding: 0.7rem; border-bottom: 1px solid #dbe6f3; text-align: center; }
    th { background: #2980b9; color: #fff; font-weight: 700; }
    tr:last-child td { border-bottom: none; }
    .spinner {
      display: inline-block;
      width: 24px;
      height: 24px;
      border: 3px solid #2980b9;
      border-top: 3px solid #fff;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      vertical-align: middle;
      margin-right: 8px;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    @media (max-width: 700px) {
      .container { padding: 1rem; }
      .logo-title { font-size: 1.3rem; }
    }
    .login-register {
      background: #f8fafc;
      padding: 1.5rem;
      border-radius: 12px;
      box-shadow: 0 2px 8px #0001;
      margin-bottom: 2rem;
      max-width: 400px;
      margin-left: auto;
      margin-right: auto;
    }
    .login-register h2 { margin-top: 0; }
    .parking-map {
      display: grid;
      grid-template-columns: repeat(5, 60px);
      gap: 16px;
      justify-content: center;
      margin: 2rem 0;
    }
    .space {
      width: 60px; height: 80px;
      background: #dbe6f3;
      border-radius: 8px;
      display: flex; flex-direction: column; align-items: center; justify-content: center;
      box-shadow: 0 2px 6px #0001;
      cursor: pointer;
      position: relative;
      transition: background 0.2s;
    }
    .space.occupied { background: #e74c3c; color: #fff; }
    .space.selected { background: #2980b9; color: #fff; }
    .space .placa { font-size: 0.9rem; font-weight: bold; margin-top: 0.3rem; }
    .space .tipo { font-size: 0.8rem; }
    .space .actions { margin-top: 0.5rem; display: flex; gap: 4px; }
    .space button { padding: 0.2rem 0.5rem; font-size: 0.8rem; border-radius: 4px; border: none; cursor: pointer; }
    .space button.add { background: #27ae60; color: #fff; }
    .space button.remove { background: #e67e22; color: #fff; }
    .space button:disabled { background: #ccc; color: #fff; cursor: not-allowed; }
    /* Estilos para el menú superior */
    .menu-superior {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
    }
    .menu-superior button {
      background: #2980b9;
      color: #fff;
      border: none;
      border-radius: 6px;
      padding: 0.5rem 1rem;
      cursor: pointer;
      font-size: 0.9rem;
      font-weight: 600;
      transition: background 0.2s;
      margin-left: 0.5rem;
    }
    .menu-superior button:hover {
      background: #3498db;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="logo">
      <div class="logo-icon">
        <!-- Simple parking logo SVG -->
        <svg viewBox="0 0 48 48"><circle cx="24" cy="24" r="22" fill="#fff"/><rect x="14" y="14" width="20" height="20" rx="6" fill="#2980b9"/><text x="24" y="32" text-anchor="middle" font-size="18" fill="#fff" font-family="Arial" font-weight="bold">P</text></svg>
      </div>
      <span class="logo-title">Parqueadero Prototipo</span>
    </div>
    <!-- Menú superior para login, registro, historial y configuración -->
    <div class="menu-superior">
      <div id="menu-session">
        <button id='btnLogin'>Iniciar sesión</button>
        <button id='btnRegister'>Registrarse</button>
        <button id='btnLogout' style='display:none;'>Cerrar sesión</button>
      </div>
      <div>
        <button id='btnHistorial'>Historial</button>
        <button id='btnTarifas'>Configurar Tarifas</button>
      </div>
    </div>
    <!-- Formularios de login y registro -->
    <div id="loginRegisterPanel" style="display:none;">
      <div class="login-register" id="loginPanel" style="display:none;">
        <h2>Iniciar sesión</h2>
        <form id="loginForm">
          <label for="loginUser">Usuario</label>
          <input id="loginUser" required maxlength="30" autocomplete="username" />
          <label for="loginPass">Contraseña</label>
          <input id="loginPass" type="password" required maxlength="30" autocomplete="current-password" />
          <button type="submit">Entrar</button>
          <div id="loginMsg"></div>
        </form>
        <div style="margin-top:1rem;text-align:center;">
          ¿No tienes cuenta? <a href="#" id="toRegister">Regístrate</a>
        </div>
      </div>
      <div class="login-register" id="registerPanel" style="display:none;">
        <h2>Registro</h2>
        <form id="registerForm">
          <label for="registerUser">Usuario</label>
          <input id="registerUser" required maxlength="30" autocomplete="username" />
          <label for="registerPass">Contraseña</label>
          <input id="registerPass" type="password" required maxlength="30" autocomplete="new-password" />
          <button type="submit">Registrarse</button>
          <div id="registerMsg"></div>
        </form>
        <div style="margin-top:1rem;text-align:center;">
          ¿Ya tienes cuenta? <a href="#" id="toLogin">Inicia sesión</a>
        </div>
      </div>
    </div>
    <!-- Main app (oculto si no hay sesión) -->
    <div id="mainApp" style="display:none;">
      <h2 style="text-align:center;">Mapa del Parqueadero</h2>
      <div id="infoEntrada" style="text-align:center;margin:1rem 0 2rem 0;font-weight:bold;color:#2980b9;">
        Para registrar la entrada de un vehículo, haz clic en un espacio vacío del mapa.
      </div>
      <div class="parking-map" id="parkingMap"></div>
      <div id="parkingMsg" style="text-align:center;"></div>
      <form id="entradaForm" style="display:none;">
        <h3>Registrar Entrada</h3>
        <label for="placaEntrada">Placa:</label>
        <input id="placaEntrada" maxlength="10" required pattern="[A-Z0-9]{5,10}" placeholder="Ej: ABC123" />
        <label for="tipoEntrada">Tipo:</label>
        <select id="tipoEntrada">
          <option value="carro">Carro</option>
          <option value="moto">Moto</option>
        </select>
        <button type="submit">Registrar Entrada</button>
        <div id="entradaMsg"></div>
      </form>
      <form id="salidaForm">
        <h3>Registrar Salida</h3>
        <label for="placaSalida">Placa:</label>
        <input id="placaSalida" maxlength="10" required pattern="[A-Z0-9]{5,10}" placeholder="Ej: ABC123" />
        <button type="submit">Registrar Salida</button>
        <div id="salidaMsg"></div>
      </form>
      <div class="vehiculos">
        <h3>Vehículos en el Parqueadero</h3>
        <table id="tablaVehiculos">
          <thead><tr><th>Placa</th><th>Tipo</th><th>Hora de Entrada</th></tr></thead>
          <tbody></tbody>
        </table>
        <div id="tablaMsg"></div>
      </div>
    </div>
  </div>
  <script>
    const api = '';
    // --- Login/Register logic ---
    function showLogin() {
      document.getElementById('loginRegisterPanel').style.display = '';
      document.getElementById('loginPanel').style.display = '';
      document.getElementById('registerPanel').style.display = 'none';
      document.getElementById('mainApp').style.display = 'none';
    }
    function showRegister() {
      document.getElementById('loginRegisterPanel').style.display = '';
      document.getElementById('loginPanel').style.display = 'none';
      document.getElementById('registerPanel').style.display = '';
      document.getElementById('mainApp').style.display = 'none';
    }
    function showMainApp() {
      document.getElementById('loginRegisterPanel').style.display = 'none';
      document.getElementById('mainApp').style.display = '';
    }
    // Eventos de navegación login/register
    document.getElementById('btnLogin').onclick = showLogin;
    document.getElementById('btnRegister').onclick = showRegister;
    document.getElementById('toRegister').onclick = showRegister;
    document.getElementById('toLogin').onclick = showLogin;
    // Login
    document.getElementById('loginForm').onsubmit = async e => {
      e.preventDefault();
      const user = document.getElementById('loginUser').value.trim();
      const pass = document.getElementById('loginPass').value;
      const msg = document.getElementById('loginMsg');
      msg.textContent = '';
      msg.className = '';
      try {
        msg.textContent = 'Verificando...';
        const res = await fetch(api + '/login', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ username: user, password: pass })
        });
        const data = await res.json();
        if (res.ok && data.token) {
          localStorage.setItem('token', data.token);
          localStorage.setItem('rol', data.rol);
          msg.textContent = '¡Bienvenido!';
          msg.className = 'success';
          setTimeout(() => {
            showMainApp();
            updateMenuSession();
            document.renderParkingMap();
            cargarVehiculos();
          }, 700);
        } else {
          msg.textContent = data.error || 'Error de autenticación';
          msg.className = 'error';
        }
      } catch {
        msg.textContent = 'Error de red.';
        msg.className = 'error';
      }
    };
    // Register
    document.getElementById('registerForm').onsubmit = async e => {
      e.preventDefault();
      const user = document.getElementById('registerUser').value.trim();
      const pass = document.getElementById('registerPass').value;
      const msg = document.getElementById('registerMsg');
      msg.textContent = '';
      msg.className = '';
      if (!user.match(/^[a-zA-Z0-9_]{3,30}$/)) {
        msg.textContent = 'Usuario inválido (3-30 letras, números o _).';
        msg.className = 'error';
        return;
      }
      if (pass.length < 4) {
        msg.textContent = 'Contraseña muy corta (mínimo 4 caracteres).';
        msg.className = 'error';
        return;
      }
      try {
        msg.textContent = 'Registrando...';
        const res = await fetch(api + '/register', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ username: user, password: pass })
        });
        const data = await res.json();
        if (res.ok && data.message) {
          msg.textContent = 'Usuario registrado. Ahora inicia sesión.';
          msg.className = 'success';
          setTimeout(showLogin, 1000);
        } else {
          msg.textContent = data.error || 'Error al registrar.';
          msg.className = 'error';
        }
      } catch {
        msg.textContent = 'Error de red.';
        msg.className = 'error';
      }
    };
    // Logout
    document.getElementById('btnLogout').onclick = () => {
      localStorage.removeItem('token');
      localStorage.removeItem('rol');
      showLogin();
      updateMenuSession();
    };
    // Mostrar/ocultar menú según sesión
    function updateMenuSession() {
      const token = localStorage.getItem('token');
      const rol = localStorage.getItem('rol');
      document.getElementById('btnLogin').style.display = token ? 'none' : '';
      document.getElementById('btnRegister').style.display = token ? 'none' : '';
      document.getElementById('btnLogout').style.display = token ? '' : 'none';
      document.getElementById('btnHistorial').style.display = rol === 'admin' ? '' : 'none';
      document.getElementById('btnTarifas').style.display = rol === 'admin' ? '' : 'none';
      document.getElementById('mainApp').style.display = token ? '' : 'none';
      document.getElementById('loginRegisterPanel').style.display = token ? 'none' : '';
    }
    // Inicialización: mostrar login o app según sesión
    if (localStorage.getItem('token')) {
      showMainApp();
    } else {
      showLogin();
    }
    updateMenuSession();
    // --- Existing code ---
    function mostrarCargando(msg) {
      document.getElementById('tablaMsg').innerHTML = `<span class="spinner"></span>${msg}`;
      document.getElementById('tablaMsg').className = 'success';
    }
    async function cargarVehiculos() {
      mostrarCargando('Cargando vehículos...');
      try {
        const res = await fetch(api + '/parqueadero');
        if (!res.ok) throw new Error('No se pudo cargar');
        const vehiculos = await res.json();
        const tbody = document.querySelector('#tablaVehiculos tbody');
        tbody.innerHTML = '';
        if (vehiculos.length === 0) {
          document.getElementById('tablaMsg').textContent = 'No hay vehículos en el parqueadero.';
          document.getElementById('tablaMsg').className = '';
        } else {
          document.getElementById('tablaMsg').textContent = '';
          vehiculos.forEach((v, i) => {
            const tr = document.createElement('tr');
            tr.innerHTML = `<td>${v.placa}</td><td>${v.tipo}</td><td>${new Date(v.horaEntrada).toLocaleString()}</td>`;
            tr.style.opacity = 0;
            setTimeout(() => { tr.style.transition = 'opacity 0.5s'; tr.style.opacity = 1; }, 100 * i);
            tbody.appendChild(tr);
          });
        }
      } catch (err) {
        document.getElementById('tablaMsg').textContent = 'Error al cargar vehículos.';
        document.getElementById('tablaMsg').className = 'error';
      }
    }
    document.getElementById('entradaForm').onsubmit = async e => {
      e.preventDefault();
      const placa = document.getElementById('placaEntrada').value.trim().toUpperCase();
      const tipo = document.getElementById('tipoEntrada').value;
      const msg = document.getElementById('entradaMsg');
      msg.textContent = '';
      msg.className = '';
      if (!placa.match(/^[A-Z0-9]{5,10}$/)) {
        msg.textContent = 'Placa inválida. Debe tener entre 5 y 10 caracteres alfanuméricos.';
        msg.className = 'error';
        return;
      }
      try {
        msg.textContent = 'Registrando...';
        msg.className = 'success';
        const res = await fetch(api + '/entrada', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ placa, tipo })
        });
        if (res.ok) {
          msg.textContent = 'Vehículo registrado correctamente.';
          msg.className = 'success';
          cargarVehiculos();
          e.target.reset();
        } else {
          const data = await res.json();
          msg.textContent = data.error || 'Error al registrar entrada.';
          msg.className = 'error';
        }
      } catch {
        msg.textContent = 'Error de red al registrar entrada.';
        msg.className = 'error';
      }
    };
    document.getElementById('salidaForm').onsubmit = async e => {
      e.preventDefault();
      const placa = document.getElementById('placaSalida').value.trim().toUpperCase();
      const msg = document.getElementById('salidaMsg');
      msg.textContent = '';
      msg.className = '';
      if (!placa.match(/^[A-Z0-9]{5,10}$/)) {
        msg.textContent = 'Placa inválida. Debe tener entre 5 y 10 caracteres alfanuméricos.';
        msg.className = 'error';
        return;
      }
      try {
        msg.textContent = 'Procesando salida...';
        msg.className = 'success';
        const res = await fetch(api + '/salida', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ placa })
        });
        if (res.ok) {
          msg.textContent = 'Salida registrada correctamente.';
          msg.className = 'success';
          cargarVehiculos();
          e.target.reset();
        } else {
          const data = await res.json();
          msg.textContent = data.error || 'Error al registrar salida.';
          msg.className = 'error';
        }
      } catch {
        msg.textContent = 'Error de red al registrar salida.';
        msg.className = 'error';
      }
    };
    // Quitar menú de login/registro/cierre de sesión
    document.querySelector('.menu-superior').style.display = 'none';
    // Ocultar formulario de entrada y mostrar mensaje instructivo
    const entradaForm = document.getElementById('entradaForm');
    entradaForm.style.display = 'none';
    const mainApp = document.getElementById('mainApp');
    const infoEntrada = document.createElement('div');
    infoEntrada.style.textAlign = 'center';
    infoEntrada.style.margin = '1rem 0 2rem 0';
    infoEntrada.style.fontWeight = 'bold';
    infoEntrada.style.color = '#2980b9';
    infoEntrada.textContent = 'Para registrar la entrada de un vehículo, haz clic en un espacio vacío del mapa.';
    mainApp.insertBefore(infoEntrada, document.getElementById('parkingMap').nextSibling);

    // --- Parking map logic ---
    const NUM_SPACES = 15;
    const spaceLabels = [
      'A1','A2','A3','A4','A5',
      'B1','B2','B3','B4','B5',
      'C1','C2','C3','C4','C5'
    ];

    const CAR_IMAGE = 'car-sprite.png.jpg';
    const MOTO_EMOJI = '🏍️';

    function getCarImageHTML(idx) {
      const col = idx % 5;
      const row = Math.floor(idx / 5);
      const x = -col * 92;
      const y = -row * 225;
      return `<div style="width:60px;height:80px;display:flex;align-items:center;justify-content:center;overflow:hidden;">
        <img src='${CAR_IMAGE}' style='width:460px;height:225px;object-fit:none;object-position:${x}px ${y}px;' alt='Carro'/>
      </div>`;
    }

    let tarifas = { carro: 2000, moto: 1000 };
    async function fetchTarifas() {
      try {
        const res = await fetch('/tarifas');
        if (res.ok) tarifas = await res.json();
      } catch {}
    }
    fetchTarifas();

    // Renderizar el mapa de parqueadero usando el backend
    document.renderParkingMap = async function renderParkingMap() {
      const map = document.getElementById('parkingMap');
      map.innerHTML = '';
      let vehiculos = [];
      try {
        const res = await fetch('/parqueadero');
        if (res.ok) {
          vehiculos = await res.json();
        }
      } catch {}
      const parkingSpaces = Array(NUM_SPACES).fill(null);
      vehiculos.forEach((v, i) => {
        if (i < NUM_SPACES) parkingSpaces[i] = v;
      });
      parkingSpaces.forEach((car, idx) => {
        const div = document.createElement('div');
        div.className = 'space' + (car ? ' occupied' : '');
        div.title = `Espacio ${spaceLabels[idx]}`;
        div.innerHTML = `<div style='font-weight:bold;font-size:1.1em;'>${spaceLabels[idx]}</div>`;
        if (car) {
          if (car.tipo === 'carro') {
            div.innerHTML += getCarImageHTML(idx);
          } else {
            div.innerHTML += `<div style='font-size:2em;margin:8px 0;'>${MOTO_EMOJI}</div>`;
          }
          div.innerHTML += `<span class='placa'>${car.placa}</span><span class='tipo'>${car.tipo}</span>`;
          if (car.horaEntrada) {
            const minutos = Math.floor((Date.now() - new Date(car.horaEntrada)) / 60000);
            div.innerHTML += `<div style='font-size:0.8em;color:#333;'>${minutos} min</div>`;
          }
          div.onclick = async () => {
            if (confirm(`¿Sacar vehículo ${car.placa} (${car.tipo}) del espacio ${spaceLabels[idx]}?`)) {
              const entrada = new Date(car.horaEntrada).getTime();
              const minutos = Math.max(1, Math.ceil((Date.now() - entrada) / 60000));
              let tarifa = 0;
              if (car.tipo === 'carro') {
                tarifa = Math.ceil(minutos / 60) * tarifas.carro;
              } else {
                tarifa = Math.ceil(minutos / 60) * tarifas.moto;
              }
              let metodo = prompt(`Tiempo: ${minutos} min\nTarifa: $${tarifa}\nSeleccione método de pago: efectivo, tarjeta, nequi, daviplata`).toLowerCase();
              if (!['efectivo','tarjeta','nequi','daviplata'].includes(metodo)) {
                alert('Método de pago no válido.');
                return;
              }
              try {
                const res = await fetch('/salida', {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify({ placa: car.placa })
                });
                if (res.ok) {
                  alert(`Pago de $${tarifa} realizado con ${metodo}. ¡Gracias!`);
                  document.renderParkingMap();
                  document.getElementById('parkingMsg').textContent = `Vehículo retirado del espacio ${spaceLabels[idx]}`;
                  cargarVehiculos();
                } else {
                  const data = await res.json();
                  alert(data.error || 'Error al registrar salida.');
                }
              } catch {
                alert('Error de red al registrar salida.');
              }
            }
          };
        } else {
          div.onclick = async () => {
            const placa = prompt(`Placa del vehículo para ${spaceLabels[idx]}:`);
            if (!placa) return;
            const placaVal = placa.trim().toUpperCase();
            const tipo = prompt('Tipo (carro/moto):');
            if (!tipo) return;
            const tipoVal = tipo.trim().toLowerCase();
            if (!placaVal.match(/^[A-Z0-9]{5,10}$/) || (tipoVal !== 'carro' && tipoVal !== 'moto')) {
              alert('Datos inválidos. Placa: 5-10 caracteres alfanuméricos. Tipo: carro o moto.');
              return;
            }
            try {
              const res = await fetch('/entrada', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ placa: placaVal, tipo: tipoVal })
              });
              if (res.ok) {
                alert('Vehículo registrado correctamente.');
                document.renderParkingMap();
                document.getElementById('parkingMsg').textContent = `Vehículo agregado al espacio ${spaceLabels[idx]}`;
                cargarVehiculos();
              } else {
                const data = await res.json();
                alert(data.error || 'Error al registrar entrada.');
              }
            } catch {
              alert('Error de red al registrar entrada.');
            }
          };
        }
        map.appendChild(div);
      });
    }

    // Inicializar y actualizar mapa y tabla
    document.renderParkingMap();
    setInterval(document.renderParkingMap, 10000);
    setInterval(cargarVehiculos, 10000);
    // Actualizar lista de vehículos cada vez que se actualiza el mapa
    document.addEventListener('DOMContentLoaded', () => {
      cargarVehiculos();
    });
  </script>
</body>
</html>
